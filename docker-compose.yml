name: arkmedia-stack

services:
  init-perms:
    image: alpine:3.21
    container_name: arkmedia-init-perms
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        mkdir -p /openlist /qbittorrent
        chown -R ${PUID}:${PGID} /openlist /qbittorrent
        chmod -R u+rwX,g+rwX /openlist /qbittorrent
    volumes:
      - ${OPENLIST_DATA}:/openlist
      - ${QBIT_CONFIG}:/qbittorrent
    restart: "no"

  caddy:
    build:
      context: .
      dockerfile: Dockerfile.caddy
    container_name: arkmedia-caddy
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - ACME_EMAIL=${ACME_EMAIL}
      - JELLYFIN_HTTPS_PORT=${JELLYFIN_HTTPS_PORT}
      - QBIT_HTTPS_PORT=${QBIT_HTTPS_PORT}
      - OPENLIST_HTTPS_PORT=${OPENLIST_HTTPS_PORT}
    ports:
      - "${JELLYFIN_HTTPS_PORT}:${JELLYFIN_HTTPS_PORT}"
      - "${QBIT_HTTPS_PORT}:${QBIT_HTTPS_PORT}"
      - "${OPENLIST_HTTPS_PORT}:${OPENLIST_HTTPS_PORT}"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ${CADDY_DATA}:/data
      - ${CADDY_CONFIG}:/config
    labels:
      - com.centurylinklabs.watchtower.enable=true
    depends_on:
      init-perms:
        condition: service_completed_successfully
      openlist:
        condition: service_started
      jellyfin:
        condition: service_started
      qbittorrent:
        condition: service_started
    networks:
      - media_net

  openlist:
    image: openlistteam/openlist:latest
    container_name: arkmedia-openlist
    restart: unless-stopped
    depends_on:
      init-perms:
        condition: service_completed_successfully
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
    volumes:
      - ${OPENLIST_DATA}:/opt/openlist/data
    ports:
      - "127.0.0.1:25244:5244"
    labels:
      - com.centurylinklabs.watchtower.enable=true
    networks:
      - media_net

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: arkmedia-jellyfin
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    volumes:
      - ${JELLYFIN_CONFIG}:/config
      - ${JELLYFIN_CACHE}:/cache
      - ${MEDIA_LOCAL_PATH}:/media/local:ro
      - ${MEDIA_INCOMING_PATH}:/media/incoming
      - ${CLOUD_MOUNT_ROOT}:/media/cloud:ro
    labels:
      - com.centurylinklabs.watchtower.enable=true
    networks:
      - media_net

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: arkmedia-qbittorrent
    restart: unless-stopped
    depends_on:
      init-perms:
        condition: service_completed_successfully
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
      - WEBUI_PORT=8080
      - TORRENTING_PORT=16881
    volumes:
      - ${QBIT_CONFIG}:/config
      - ${DOWNLOADS_PATH}:/downloads
      - ${MEDIA_INCOMING_PATH}:/media/incoming
      - ./scripts/qbittorrent-init/10-reverse-proxy.sh:/custom-cont-init.d/10-reverse-proxy.sh:ro
    ports:
      - "16881:16881/tcp"
      - "16881:16881/udp"
    labels:
      - com.centurylinklabs.watchtower.enable=true
    networks:
      - media_net

  watchtower:
    image: containrrr/watchtower:latest
    container_name: arkmedia-watchtower
    restart: unless-stopped
    command:
      - --label-enable
      - --cleanup
      - --interval
      - "86400"
    environment:
      - DOCKER_API_VERSION=1.44
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - media_net

networks:
  media_net:
    driver: bridge
